name: Deploy Staging Environment

on:
  push:
    branches:
      - main
      - develop
      - release-*

env:
  STAGING_DEVELOP_VM: 10.3.7.166
  STAGING_DEVELOP_HOSTNAME: develop.stage.slm.vfk
  STAGING_RELEASE_VM: 10.3.7.145
  STAGING_RELEASE_HOSTNAME: main.stage.slm.vfk

jobs:
  deploy-staging-environment:
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v3
      - name: Test secret
        run: |
          echo ${{ secrets.RUNNER_PRIVATE_KEY }} >> tmp.key
      - name: SSH Remote Commands
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{env.STAGING_DEVELOP_VM}}
          key: ${{ secrets.RUNNER_PRIVATE_KEY }}-
          script: |
            cd /staging/tmp/stack/compose
            docker-compose down --volumes
            docker system prune -f
            cd /staging && rm -r tmp & mkdir tmp && cd tmp
            git clone -b $GITHUB_REF_NAME https://github.com/$GITHUB_REPOSITORY.git
            cd slm
            CORE_VERSION=$(cat pom.xml | grep -oPm1 "(?<=<revision>)[^<]+")
            cd stack/compose
            sed -ir "s/^[#]*\s*SLM_HOSTNAME=.*/SLM_HOSTNAME=$STAGING_DEVELOP_HOSTNAME/" .env
            sed -ir "s/^[#]*\s*SLM_VERSION=.*/SLM_VERSION=$CORE_VERSION/" .env
            echo ${{secrets.GITHUB_TOKEN}} | docker login -u${{github.actor}} --password-stdin ghcr.io
            docker-compose pull
            docker-compose up -d --force-recreate
