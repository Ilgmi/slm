- name: "Vault | Start"
  block:
  - set_fact:
      vault_url: "{{ vault_scheme }}://{{ vault_host }}:{{ vault_port }}"
  - name: "Vault | Create compose definition from template"
    set_fact:
      vault_compose: "{{ lookup('template', './templates/base.vault.yml') }}"
  - name: "Vault |  Start containers"
    community.docker.docker_compose:
      project_name: eclipse-slm
      definition: "{{ vault_compose | from_yaml}}"
    register: vault_compose_start_output
  - name: "Vault | Wait for Vault being up"
    uri:
      url: "{{ vault_url }}"
      status_code: 200
    register: result
    until: result.status == 200
    retries: 120
    delay: 3
  - name: "Vault | Get Vault root token"
    community.docker.docker_container_exec:
      container: "{{ vault_compose_start_output.services.vault | first }}"
      command: "grep 'Token' /vault/config/root/vault_init_msg"
    register: vault_root_token_line
    until: "vault_root_token_line is not failed"
    retries: 10
    delay: 3
  - set_fact:
      vault_root_token: "{{ vault_root_token_line.stdout | regex_search('Initial Root Token: (.*)', '\\1') | first }}"

- name: "Vault | Init"
  include_role:
    name: vault_init
    tasks_from: vault_init.yml
